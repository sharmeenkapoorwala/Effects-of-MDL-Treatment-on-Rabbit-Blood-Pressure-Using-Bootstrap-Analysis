---
title: "Effects of MDL Treatment on Rabbit Blood Pressure Using Bootstrap Analysis"
author: "Sharmeen Kapoorwala, Katherine Rodriguez, Huiting Wu"
date: "`r Sys.Date()`"
format: 
  pdf:
    latex-engine: pdflatex
    titlepage: true
geometry: top=1in, bottom=1in, left=1in, right=1in
header-includes:
  - \pagestyle{myheadings}
  - \markright{}
  - \usepackage{titling}
  - \setlength{\parindent}{1.5em}
  - \pretitle{\begin{center}\vspace*{\fill}\LARGE\bfseries}
  - \posttitle{\par\end{center}\vskip 1em}
  - \preauthor{\begin{center}\large}
  - \postauthor{\par\end{center}\vskip 1em}
  - \predate{\begin{center}\large}
  - \postdate{\par\end{center}\vspace*{\fill}}
---
\newpage

```{r library, message=FALSE, include=FALSE, warning=FALSE}
library(infer)
library(MASS)
library(dplyr)
library(tidyverse)
library(lmtest)
library(boot)
library(kableExtra)
library(lmboot)
library(ClusterBootstrap)
library(patchwork)
library(lme4)
```

```{r data, message=FALSE, include=FALSE, warning=FALSE, echo=FALSE}
MDL <- Rabbit |> filter(Treatment == "MDL") |> 
  pivot_wider(
    names_from = Treatment,
    values_from = BPchange,
    names_prefix = "BPchange_") |> 
  select(-Run)

crl <- Rabbit |> filter(Treatment == "Control") |> 
  pivot_wider(
    names_from = Treatment,
    values_from = BPchange,
    names_prefix = "BPchange_") |> 
  select(-Run)

bunny <- left_join(MDL, crl, by = c("Dose", "Animal")) |> 
  mutate(diff_change = BPchange_MDL - BPchange_Control) |>
  select(Dose, Animal, BPchange_MDL, BPchange_Control, diff_change)
```

```{r hypothesis, include=FALSE, warning=FALSE, echo=FALSE}
set.seed(2025)
rabbit_diff <- bunny |> group_by(Animal) |> 
  # find the average difference of blood pressure change across doses by rabbits
  summarise(mean_diff = mean(diff_change)) |> pull(mean_diff)
# observation statistic is the mean of average difference of blood pressure change
obs_mean <-  mean(rabbit_diff)
# put the difference in a data frame
diff_data <- tibble(diff = rabbit_diff)

boot_dist <- diff_data |>  specify(response = diff) |> 
  hypothesise(null = "point", mu = 0) |> 
  generate(reps = 1000, type = "bootstrap") |> 
  calculate(stat = "mean")

# 95% Confidence Interval
dist <- diff_data |>  specify(response = diff) |> 
  generate(reps = 1000, type = "bootstrap") |> 
  calculate(stat = "mean")

endpoints <- get_ci(dist)

# 95% Bac Confidence Interval
bac <- dist |> 
  get_confidence_interval(point_estimate = obs_mean,
                          type = "bias-corrected")
lower.ci <- bac |> pull(lower_ci)
upper.ci <- bac |> pull(upper_ci)
```

```{r regression, include=FALSE, warning=FALSE, echo=FALSE}
mod1 <- lm(log(BPchange) ~ Dose + I(Dose^2) + Treatment, data = Rabbit)
set.seed(2025)
cluster_boot <- clusbootglm(
  model = mod1,
  data = Rabbit,
  clusterid = Rabbit$Animal,
  family = gaussian,
  B = 1000
)
```

# Introduction

## Research Question & Objectives
In comparison to a saline (placebo) control, the purpose of this study is to determine if the administration of the $5-HT_3$ antagonist modifies the dose–response relationship of mean arterial blood pressure variations generated by increasing doses of phenylbiguanide in rabbits. In particular, we want to estimate confidence intervals for the variations in blood-pressure response between treatment and control groups over dosages using a resampling (bootstrapping) technique.

## Motivation
The initial experiment aimed to determine if phenylbiguanide-induced cardiogenic chemoreflex is dependent on $5-HT_3$ receptor activation. Given the very small sample (5 rabbits, repeated measures), using contemporary resampling (bootstrap) techniques enables a non-parametric evaluation of variability and more reliable inference.  Classical parametric tests can be supplemented (or replaced) by bootstrap confidence intervals and hypothesis tests, which account for repeated-measures structure and make less assumptions on distributional shape.

# Data Description

The Rabbit dataset is from the MASS package in R which includes 60 observations of variations in rabbit blood pressure under various experimental settings. BPchange (change in blood pressure relative to the start of the experiment), Dose (dose of Phenylbiguanide in micrograms), Run (label of run ("C1" to "C5", then "M1" to "M5")), Treatment (placebo or the 5-HT_3 antagonist MDL 72222) and Animal (label of animal used ("R1" to "R5")).Each rabbit in the experiment (from Ludbrook, 1994) was given both treatment conditions and escalating intravenous doses of PBG, a 5-HT₃ agonist that causes a cardiogenic chemoreflex, every 10 minutes. The purpose was to determine whether 5-HT₃ receptor activation is necessary for PBG-induced blood pressure changes.

# Methods

In this work, we used regression, mixed-effects modeling, and hypothesis testing to look at how therapy affected blood pressure changes. We also used bootstrap techniques to deal with the repeated-measures design. We conducted a one-sample, two-sided bootstrap hypothesis test (using **infer**) based on the average within-rabbit differences across doses to determine whether the mean difference in BPchange between treatment and control differs from zero. Despite the enormous sample size, bootstrap resampling was chosen since repeated measurements contradict independence.

  Next, we expanded the results to a regression model with dose, $dose^2$ and treatment as predictors and the natural log of BPchange as the response. Since the normality and equal-variance requirements were satisfied but the independence assumption was not, we used a cluster bootstrap to estimate the regression coefficients by treating each rabbit as a cluster and resampling entire clusters.  Bootstrap estimates of the model coefficients were obtained using the **ClusterBootstrap** package. 

  Concluding with a mixed-effects model, we introduce a model that accounts for within-subject correlation by incorporating random effects for each animal alongside Treatment and Dose as fixed effects, as well as their interactions. Dose is treated as a factor with six levels (6.25, 12.5, 25, 50, 100, 200 $\mu g$) to evaluate the effects of dose level on blood pressure change. Examining model assumptions, we find that normality is satisfied, while equal variance displayed slight heteroscedasticity.Independence continues to be violated due to the repeated measurements of rabbits. Bootstrapping using the bootMer() function from the **lme4** package was implemented to generate confidence intervals by applying parametric resampling to the model to extract fixed effect estimates. This final procedure allowed us to examine the effects of treatment at each dose level while accounting for subject variability.

# Results And Discussion

```{r echo = FALSE, message=FALSE, warning=FALSE, fig.height = 3, fig.width=8}
ggplot(bunny, aes(x = as.factor(Dose), 
                  y = diff_change, 
                  colour = Animal,
                  group = Animal
)) +
  geom_point(size = 3) +
  geom_line() +
  labs(x = "Dose",
       y = "Difference in BPchange",
       title = "Relationship of Difference in Blood Pressure Change 
       Across Dose by Rabbits") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
  )
```

  We first visualized the variation in blood pressure change between treatment and control using the previously mentioned techniques.  The lines, each of which represents a single rabbit, exhibit comparable general patterns.  While changes are minimal at dosages of 6.15, 12.5, 25, and 200, they are most noticeable at doses of 50 and 100, where treatment results in a significantly smaller BP decrease than control.The formal studies that follow were inspired by these visual patterns.  The results of the hypothesis test, ANOVA, and regression, which measure the impact of treatment on blood-pressure change, are shown in the following sections.  

  We started with a hypothesis test comparing the mean difference in BPchange between treatment and control to determine whether treatment had a meaningful effect.
 
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=2.5, fig.width=8}
p1 <- visualize(boot_dist) +
shade_p_value(obs_mean, direction = "both") +
labs(title = "Visualization of p-value") +
  theme(
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
  )

p2 <- visualize(dist) +
shade_confidence_interval(endpoints = endpoints) +
labs(title = "Visualization of 
     95 % Confidence Interval",
     ) +
  theme(
    plot.title = element_text(size = 12),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
  )
p1 + p2 + plot_layout(ncol = 2)
```

  The 95\% confidence interval of the true mean difference is 
\(\text{`r round(endpoints[1],2)`}, \text{`r round(endpoints[2],2)`}\). The 95\% BCa confidence interval of the true mean difference is 
\(\text{`r round(lower.ci,2)`}, \text{`r round(upper.ci,2)`}\).


  There is a significant mean difference in BPchange between treatment and control, as indicated by the hypothesis test's extremely small p-value and both confidence intervals' exclusion of 0.  The medication generally lowers blood pressure, which is consistent with the activation of $5-HT_3$ receptors in the phenylbiguanide-induced cardiogenic chemoreflex. 
Next, we used regression to model the relationship between BPchange and its variables.
  
  The model is ln(BPchange) = $\beta_0 + \beta_1 Dose + \beta_2 Dose^2 + \beta_3 Treatment + \epsilon$
  

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=4, fig.width=8}
# checking assumptions
par(mfrow = c(1, 2))
plot(mod1, 1:2)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Run Breusch-Pagan test
bp_res <- bptest(mod1)

# Convert the result to a data frame
bp_table <- data.frame(
  Statistic = bp_res$statistic,
  df = bp_res$parameter,
  p_value = bp_res$p.value
)

# Display as a nice table
kable(bp_table, digits = 4, caption = "Breusch-Pagan Test for Heteroskedasticity")
```

 The Breusch-Pagan test is supported by the residuals vs. fitted plot, which displays nearly constant variation across groups. The residuals closely match the reference line, indicating that the normality assumption is reasonable, according to the normal Q-Q plot. The equal-variance and normalcy requirements are therefore satisfied. Since the independence condition has been violated we estimate the model coefficients using bootstrap methods.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# intervals
param <- cluster_boot$parametric.interval
bca <- cluster_boot$BCa.interval
perc <- cluster_boot$percentile.interval

# Create a data frame with rounded values
ci_table <- data.frame(
  Coefficient = rownames(param),
  Parametric = paste0("(", round(param[,1],4), ", ", round(param[,2],4), ")"),
  BCa = paste0("(", round(bca[,1],4), ", ", round(bca[,2],4), ")"),
  Percentile = paste0("(", round(perc[,1],4), ", ", round(perc[,2],4), ")")
)

# Print table
ci_table |>
  kable(caption = "Comparison of Confidence Intervals for Model Coefficients")
```

  The results of the hypothesis test are consistent with the regression coefficient confidence intervals. The parametric intervals are closely matched by the percentile and BCa intervals. Although they are close to zero, the intercept, dose, and $dose^2$ coefficients do not include 0, suggesting minor but nonzero effects. In aligned with the hypothesis test, the TreatmentMDL coefficient is negative and its intervals do not contain 0. This indicates that, when other predictors are held constant, MDL somewhat reduces the change in blood pressure compared to control.

  Following the regression analysis, we move on to the mixed-effects model, $ln(BPchange) = \beta_0 + \beta_1 Treatment + \beta_2 Dose + \beta_3 Treatment*Dose + u_{Animal} + \epsilon$.

```{r mixed effects model,include=FALSE, echo=FALSE, warning=FALSE}
#Factor dose variable
Rabbit$f_dose <- factor(Rabbit$Dose,
                        levels = c(6.25, 12.5, 25, 50, 100, 200))

#Mixed effects model
lmer_rab <- lmer(log(BPchange) ~ Treatment * f_dose + (1 | Animal), data = Rabbit)
summary(lmer_rab)
```



```{r, echo=FALSE, warning=FALSE, fig.height=4,fig.width=8}
#Put both equal variance and normality side by side
par(mfrow = c(1,2))

#Equal Variance: Residuals vs Fitted Values
plot(fitted(lmer_rab), residuals(lmer_rab, type = "pearson"),
     main = "Residual vs Fitted Values",
     xlab = "Fitted Values",
     ylab = "Residuals")
abline(h = 0, col = "red", lwd = 1)

#Normality: QQ - plot
qqnorm(residuals(lmer_rab, type = "pearson"))
qqline(residuals(lmer_rab, type = "pearson"), col = "red")

par(mfrow = c(1,1))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

#Shapiro Wilks Test 
shap_rabbit <- shapiro.test(residuals(lmer_rab))

#Create Shapiro - Wilk dataframe to enable creation of a table
shap_tb <- data.frame(
  Statistic = c("W", "P - Value"),
  Value = c("0.98367", "0.6014")
  
)
#Shapiro table
options(knitr.kable.NA = ' ')
kable(shap_tb,
      caption = "Shapiro - Wilk")
```

  Normality is satisfied, with the Q - Q plot indicating the residuals approximately following a normal distribution, additionally the Shapiro - Wilk test further supports this assumption. Equal variance shows a slight funneling pattern, indicating some heteroscedasticity, nonetheless, equal variance is largely satisfied. Due to independence being violated, bootstrap simulations were generated on the mixed-effects model to obtain confidence intervals for fixed effect estimates.

```{r bootstrap, include=FALSE, echo=FALSE, warning=FALSE}
#Bootstrapping the mixed effects model

#Function for bootstrap
boot_function <- function(mod) {
  fixef(mod)
}

#Use bootmer() bootstrap function from lme4
set.seed(641)
boot_lmer_rab <- bootMer(
  lmer_rab,
  FUN = boot_function,
  nsim = 2000,
  type = "parametric"
) 

boot_lmer_rab

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Initial preparation for confidence interval table
coef_name <- names(fixef(lmer_rab))
est_boot <- fixef(lmer_rab) 
ci_lmer_tb <- data.frame(
  Coefficient = coef_name,
  Estimate = round(est_boot, 4),
  Parametric = NA,
  Percentile = NA,
  stringsAsFactors = FALSE,
  row.names = NULL
)

#Pull the coefficient for CI
for (i in seq_along(coef_name)) {
  ci_lmer <- boot.ci(boot_lmer_rab, type = c("norm", "perc"), index = i)
  
  #Parametric CI
  ci_lmer_tb$Parametric[i] <- sprintf("(%0.4f, %0.4f)", ci_lmer$normal[2], ci_lmer$normal[3])
  
  #Percentile CI
  ci_lmer_tb$Percentile[i] <- sprintf("(%0.4f, %0.4f)", ci_lmer$percent[4], ci_lmer$percent[5])
              
}

#Tidy names of coefficients for table
ci_lmer_tb <- ci_lmer_tb |>
  mutate(Coefficient = case_when(
    Coefficient == "f_dose12.5" ~ "Dose 12.5",
    Coefficient == "f_dose25" ~ "Dose 25",
    Coefficient == "f_dose50" ~ "Dose 50",
    Coefficient == "f_dose100" ~ "Dose 100",
    Coefficient == "f_dose200" ~ "Dose 200",
    Coefficient == "TreatmentMDL:f_dose12.5" ~ "TreatmentMDL:Dose 12.5",
    Coefficient == "TreatmentMDL:f_dose25" ~ "TreatmentMDL:Dose 25",
    Coefficient == "TreatmentMDL:f_dose50" ~ "TreatmentMDL:Dose 50",
    Coefficient == "TreatmentMDL:f_dose100" ~ "TreatmentMDL:Dose 100",
    Coefficient == "TreatmentMDL:f_dose200" ~ "TreatmentMDL:Dose 200",
    TRUE ~ Coefficient
))

#Generate Table
kable(
  ci_lmer_tb,
  caption = "Confidence Intervals for Mixed Effects Model Coefficients",
  align = c("l", "c", "c", "c"),
  col.names = c("Coefficient", "Estimate", "Parametric CI", "Percentile CI"),
  digits = 4
)
```

  Consistent with the hypothesis test and regression analysis, the mixed - effects bootstrapping analysis confirms that MDL reduces blood pressure change compared to the control. The MDL coefficient interval includes 0, indicating its effect is not statistically significant. Dose coefficients were all positive with ranges well above 0, indicating a clear dose-response relationship, with increasing blood pressure change up to dose level 100, plateauing between 100 and 200. Confidence intervals for treatment and dose interactions across 12.5 - 100 dose levels do not include 0, indicating blood pressure reduction is evident, with dose level 50 having the greatest reduction. This suggests MDL's treatment effect on blood pressure change is dose dependent, MDL reduces blood pressure at low to moderate doses, excluding the highest dose level of 200, as its confidence interval includes 0.

# Conclusion
The hypothesis test showed a significant mean difference in BPchange from treatment to control, with confidence intervals excluding 0 and a very small p-value, indicating that the treatment helps reduce blood pressure change on average. Regression analysis using cluster bootstrap confirmed that dose, $dose^2$, and treatment significantly affect BPchange, providing bootstrap estimates on coefficients despite repeated measurements. Mixed-effects modeling with parametric bootstrapping highlighted the dose-response relationship; increasing dose levels produced greater blood pressure change with the exception of the highest dose level. In summary, these findings consistently demonstrate MDL treatment effectively reduces blood pressure in rabbits at specific dose levels. 
Expanding the study to include rabbits of different species or even other animal models could be helpful to future research as it would increase the variety of biological behaviors observed. By combining machine learning techniques with these larger datasets, more advanced pattern identification and predictive modeling would be possible, assisting in the discovery of subtle treatment effects that traditional statistical methods could detect. To confirm whether the reported dose-dependent effects of MDL represent true biological variability or are merely artifacts of sampling restrictions, future research including bigger and more varied animal samples would be beneficial.


\newpage

# Appendix

## Tidy the table

```{r eval = FALSE}
MDL <- Rabbit |> filter(Treatment == "MDL") |> 
  pivot_wider(
    names_from = Treatment,
    values_from = BPchange,
    names_prefix = "BPchange_") |> 
  select(-Run)

crl <- Rabbit |> filter(Treatment == "Control") |> 
  pivot_wider(
    names_from = Treatment,
    values_from = BPchange,
    names_prefix = "BPchange_") |> 
  select(-Run)

bunny <- left_join(MDL, crl, by = c("Dose", "Animal")) |> 
  mutate(diff_change = BPchange_MDL - BPchange_Control) |>
  select(Dose, Animal, BPchange_MDL, BPchange_Control, diff_change)
```

## Visualization

```{r eval = FALSE}
ggplot(bunny, aes(x = as.factor(Dose), 
                  y = diff_change, 
                  colour = Animal,
                  group = Animal
)) +
  geom_point(size = 3) +
  geom_line() +
  labs(x = "Dose",
       y = "Difference in BPchange")
```

## Hypothesis Test on mean of difference in mean change of blood pressure

The $\mu_{diff}$ is the mean of average difference in BPchange from treatment to the control group across doses by rabbits.

BPchange is the change in blood pressure after treatment or control.

$H_0: \mu_{diff} = 0$ There is no mean difference of average difference in BPchange by treatment or control.

$H_A: \mu_{diff} \ne 0$ There is mean difference of average difference in BPchange by treatment or control.

```{r eval = FALSE}
rabbit_diff <- bunny |> group_by(Animal) |> 
  # find the average difference of blood pressure change across doses by rabbits
  summarise(mean_diff = mean(diff_change)) |> pull(mean_diff)
# observation statistic is the mean of average difference of blood pressure change
obs_mean <-  mean(rabbit_diff)
```

```{r eval = FALSE}
# put the difference in a data frame
diff_data <- tibble(diff = rabbit_diff)
set.seed(2025)
boot_dist <- diff_data |>  specify(response = diff) |> 
  hypothesise(null = "point", mu = 0) |> 
  generate(reps = 1000, type = "bootstrap") |> 
  calculate(stat = "mean")

# p-value
visualize(boot_dist) + shade_p_value(obs_mean, direction = "both")

# 95% Confidence Interval
dist <- diff_data |>  specify(response = diff) |> 
  generate(reps = 1000, type = "bootstrap") |> 
  calculate(stat = "mean")

endpoints <- get_ci(dist)
endpoints
visualize(dist) + shade_confidence_interval(endpoints = endpoints)

# 95% Bac Confidence Interval
dist |> 
  get_confidence_interval(point_estimate = obs_mean,
                          type = "bias-corrected")
```

## Regression

Model: ln(BPchange) = $\beta_0 + \beta_1 Dose + \beta_2 Dose^2 + \beta_3 Treatment + \epsilon$

```{r eval=FALSE}
mod1 <- lm(log(BPchange) ~ Dose + I(Dose^2) + Treatment, data = Rabbit)
summary(mod1)
```

```{r eval=FALSE}
# checking assumptions
plot(mod1, 1:2)
```

```{r eval=FALSE}
bptest(mod1) # equal variance
```

### cluster bootstrap

```{r eval=FALSE}
set.seed(2025)
cluster_boot <- clusbootglm(
  model = mod1,
  data = Rabbit,
  clusterid = Rabbit$Animal,
  family = gaussian,
  B = 1000
)
```

### confidence intervals of coefficients

```{r eval=FALSE}
# the theory confidence interval of the model
cluster_boot$parametric.interval
```
```{r eval=FALSE}
# bootstrap Bca confidence interval
cluster_boot$BCa.interval
```

```{r eval=FALSE}
# bootstrap percentile confidence interval
cluster_boot$percentile.interval
```

## Mixed Effects Model

Interactions between Treatment and Dose

### Factor Dose

```{r eval = FALSE}
Rabbit$f_dose <- factor(Rabbit$Dose)

levels(Rabbit$f_dose)
```

### Preliminary Visualizations: Stripchart/Boxplot

\underline{Stripchart}

```{r eval = FALSE}
stripchart(BPchange ~ f_dose * Treatment, data = Rabbit, vertical = TRUE,
           col = c("red", "blue", "green"),
           main = "Treatment Effect on Blood Pressure in Rabbits",
           xlab = "Dose Level",
           ylab = "Blood Pressure Change")
```

\underline{Boxplot}

```{r eval = FALSE}
#Boxplot
ggplot(Rabbit, aes(x = f_dose, y = BPchange, fill = Treatment)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(aes(shape = f_dose), width = 0.5, size = 3) +
  labs(
    title = "Treatment Effect on Blood Pressure in Rabbits",
    x = "Dose Level",
    y = "Blood Pressure Change") +
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5))
```

\underline{Aggregate Means}

```{r eval = FALSE}
ms_rabbit <- aggregate(BPchange ~ f_dose * Treatment, data = Rabbit, FUN = mean)
ms_rabbit
```

\underline{Plot Group Means}

```{r eval = FALSE}
ggplot(ms_rabbit, aes(x = f_dose, y = BPchange, col = Treatment)) +
  geom_jitter(aes(shape = f_dose), width = 0.5, size = 4) +
  scale_y_continuous(limits = c(0,30)) +
  labs(
    title = "Treatment Effect on Blood Pressure Change in Rabbits",
    x = "Dose Level",
    y = "Blood Pressure Change") +
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5))
```

\underline{Interactions Plot}

```{r eval = FALSE}
#Interaction plot

with(Rabbit, interaction.plot(x.factor = f_dose, trace.factor = Treatment,
response = BPchange, col = c("black", "red"), pch = c(18,19), type = "b"))
```

Discussion: Interactions do exist.

\underline{Fit the Mixed-Effect Model}

```{r eval = FALSE}

#Factor dose variable
Rabbit$f_dose <- factor(Rabbit$Dose,
                        levels = c(6.25, 12.5, 25, 50, 100, 200))

lmer_rab <- lmer(log(BPchange) ~ Treatment * f_dose + (1 | Animal), data = Rabbit)
summary(lmer_rab)
```

### Diagnostics

\underline{Normality and Equal Variance}

```{r, eval = FALSE, echo=FALSE, warning=FALSE, fig.height=3,fig.width=8}
#Put both equal variance and normality side by side
par(mfrow = c(1,2))

#Equal Variance: Residuals vs Fitted Values
plot(fitted(lmer_rab), residuals(lmer_rab, type = "pearson"),
     main = "Residual vs Fitted Values",
     xlab = "Fitted Values",
     ylab = "Residuals")
abline(h = 0, col = "red", lwd = 1)

#Normality: QQ - plot
qqnorm(residuals(lmer_rab, type = "pearson"))
qqline(residuals(lmer_rab, type = "pearson"), col = "red")

par(mfrow = c(1,1))
```

\underline{Shapiro Wilk}

```{r eval = FALSE}
shap_rabbit <- shapiro.test(residuals(lmer_rab))

#Create Shapiro - Wilk dataframe to enable creation of a table
shap_tb <- data.frame(
  Statistic = c("W", "P - Value"),
  Value = c("0.98367", "0.6014")
  
)
#Shapiro table
options(knitr.kable.NA = ' ')
kable(shap_tb,
      caption = "Shapiro - Wilk")
```

## Bootstrapping Mixed Model

```{r eval = FALSE}
boot_function <- function(mod) {
  fixef(mod)
}

set.seed(641)
boot_lmer_rab <- bootMer(
  lmer_rab,
  FUN = boot_function,
  nsim = 2000,
  type = "parametric",
   use.u = TRUE
) 

boot_lmer_rab
```

\underline{Confidence Interval}

```{r eval = FALSE}
#Initial preparation for confidence interval table
coef_name <- names(fixef(lmer_rab))
ci_lmer_tb <- data.frame(
  Coefficient = coef_name,
  Parametric = NA,
  Percentile = NA,
  stringsAsFactors = FALSE,
  row.names = NULL
)

#Pull the coefficient for CI
for (i in seq_along(coef_name)) {
  ci_lmer <- boot.ci(boot_lmer_rab, type = c("norm", "perc"), index = i)
  
  #Parametric CI
  ci_lmer_tb$Parametric[i] <- sprintf("(%0.4f, %0.4f)", ci_lmer$normal[2], 
                                      ci_lmer$normal[3])
  
  #Percentile CI
  ci_lmer_tb$Percentile[i] <- sprintf("(%0.4f, %0.4f)", ci_lmer$percent[4], 
                                      ci_lmer$percent[5])
              
}

kable(
  ci_lmer_tb,
  caption = "Confidence Intervals for Mixed Effects Model Coefficients",
  align = c("l", "c", "c"),
  col.names = c("Coefficient", "Parametric CI", "Percentile CI"),
  digits = 4
)
```

# Reference

* chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://cran.r-project.org/web/packages/ClusterBootstrap/ClusterBootstrap.pdf

* https://pmc.ncbi.nlm.nih.gov/articles/PMC5965657/#section3-0013164416678980

* J. Ludbrook (1994) Repeated measurements and multiple comparisons in cardiovascular research. Cardiovascular Research 28, 303–311.

* Venables, W. N. & Ripley, B. D. (2002) Modern Applied Statistics with S. Fourth Edition. Springer, New York. ISBN 0-387-95457-0

* https://search.r-project.org/CRAN/refmans/lme4/html/bootMer.html